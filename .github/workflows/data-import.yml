name: Data Import to AWS ECS
on:
  workflow_dispatch:
    inputs:
      tier:
        description: 'Deployment tier'
        required: true
        type: choice
        options:
          - dev
          - qa
          - stage
          - prod

jobs:
  data-import:
    timeout-minutes: 10
    runs-on: ubuntu-latest
    environment: ${{ inputs.tier }}
    env:
      APP: mca-explorer
      AWS_REGION: us-east-1
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      DATA_IMPORT_CONTAINER_PORT: 9000
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.1
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/power-user-github-actions-cicd
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup environment variables
        run: |
          echo "TIER=${{ inputs.tier }}" >> $GITHUB_ENV
          echo "TIER_UPPER=$(echo ${{ inputs.tier }} | tr '[:lower:]' '[:upper:]')" >> $GITHUB_ENV
          echo "DATETIME=$(date +%Y%m%d%H%M%S)" >> $GITHUB_ENV
          echo "APP_GIT_TAG=${GITHUB_SHA::7}" >> $GITHUB_ENV
          echo "PARAMETER_PATH=/analysistools/${{ inputs.tier }}/${{ env.APP }}" >> $GITHUB_ENV
          if [[ "${{ inputs.tier }}" == "prod" || "${{ inputs.tier }}" == "stage" ]]; then
            echo "IMAGE_TIER=release" >> $GITHUB_ENV
          else
            echo "IMAGE_TIER=development" >> $GITHUB_ENV
          fi

      - name: Set Docker registry and repository
        run: |
          echo "DOCKER_REGISTRY=${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com" >> $GITHUB_ENV
          echo "IMAGE_REPOSITORY=${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.APP }}" >> $GITHUB_ENV

      - name: Set data import image tags
        run: |
          echo "DATA_IMPORT_IMAGE=${{ env.IMAGE_REPOSITORY }}:${{ env.IMAGE_TIER }}-data-import-${{ env.APP_GIT_TAG }}-${{ env.DATETIME }}" >> $GITHUB_ENV
          echo "DATA_IMPORT_IMAGE_LATEST=${{ env.IMAGE_REPOSITORY }}:${{ env.IMAGE_TIER }}-data-import-latest" >> $GITHUB_ENV

     
      - name: Retrieve SSM parameters
        run: |
          PARAMETER_PATH="/analysistools/${TIER}/${APP}"

          # Define parameters to retrieve (SSM name = ENV_VAR_NAME)
          declare -A PARAMS=(
            ["ecs_cluster"]="ECS_CLUSTER"
            ["ecs_web_task"]="ECS_WEB_TASK"
            ["ecs_web_service"]="ECS_WEB_SERVICE"
            ["role_arn"]="ROLE_ARN"
          )

          # Retrieve each parameter and export to environment
          for ssm_name in "${!PARAMS[@]}"; do
            env_var="${PARAMS[$ssm_name]}"
            echo "Retrieving ${PARAMETER_PATH}/${ssm_name} -> ${env_var}"
            value=$(aws ssm get-parameter \
              --name "${PARAMETER_PATH}/${ssm_name}" \
              --with-decryption \
              --query "Parameter.Value" \
              --output text 2>&1) || {
                echo "ERROR: Failed to retrieve parameter: ${PARAMETER_PATH}/${ssm_name}"
                exit 1
              }
            echo "${env_var}=${value}" >> $GITHUB_ENV
            echo "âœ“ Retrieved ${ssm_name} -> ${env_var}"
          done

      - name: Login to Amazon ECR
        run: aws ecr get-login-password | docker login --username AWS --password-stdin ${{ env.DOCKER_REGISTRY }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push data import image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/data-import.dockerfile
          pull: true
          push: true
          tags: |
            ${{ env.DATA_IMPORT_IMAGE }}
            ${{ env.DATA_IMPORT_IMAGE_LATEST }}
          cache-from: type=registry,ref=${{ env.DATA_IMPORT_IMAGE_LATEST }}
          cache-to: type=inline

      - name: Prepare data-import task definition
        run: |
          mkdir -p ecs-tasks
          envsubst < .github/aws/data-import.yml > ecs-tasks/data-import.yml

      - name: Register data import task definition
        run: aws ecs register-task-definition --cli-input-yaml file://ecs-tasks/data-import.yml

      - name: Run data import task
        run: |
          aws ecs run-task \
            --cluster ${{ env.ECS_CLUSTER }} \
            --count 1 \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=[${{ env.SUBNET_IDS }}],securityGroups=[${{ env.SECURITY_GROUP_IDS }}]}" \
            --task-definition ${{ env.ECS_DATA_IMPORT_TASK }}
